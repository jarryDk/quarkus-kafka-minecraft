= Use Kafka and Quarkus to track players in Minecraft

This project is created to show how to track players movement in Minecraft via Kafka and Quarkus.

image::images/show_player_in_browser.png[]

The Minecraft mod `kafkamod` might be a bit to chatty, but it is nice doing development.

TIP: Start Kafka before starting the Minecraft server.

NOTE: I have some issues with `legacyClassPath` and fix it by running the `kafkamod` directly on a forge Minecraft server.


Inspiration: https://github.com/holly-cummins/quarkus-minecraft-observability-extension

== Requeriments

- https://kafka.apache.org[Kafka]
- https://files.minecraftforge.net/net/minecraftforge/forge/[Minecraft Forge]

== Minecraft Kafka mod

The `kafkamod` send a record to Kafka when a player chat, pick up an item or craft an item.

.Record sendt to Kafka when a player chat

[source,json]
----
{
    "player": {
        "name": "jarry_dk",
        "ipAddress": "127.0.0.1",
        "y": 67.0,
        "x": -1.3881068355791462,
        "z": 12.062554759895784
    },
    "message": "From MineCraft"
}
----

.Record sendt to Kafka when crafting an item

[source,json]
----
{
    "player": {
        "name": "jarry_dk",
        "ipAddress": "127.0.0.1",
        "y": 67.0,
        "x": -1.3881068355791462,
        "z": 12.062554759895784
    },
    "typeOfEvent": "Crafted",
    "displayName": "Spruce Planks"
}
----

.Record sendt to Kafka when picking up an item

[source,json]
----
{
  "player": {
    "name": "jarry_dk",
    "ipAddress": "127.0.0.1",
    "y": 67.0,
    "x": -1.3881068355791462,
    "z": 12.062554759895784
  },
  "typeOfEvent": "Pickup",
  "displayName": "Dirt"
}
----


=== Fixing legacyClassPath

Open this file `/opt/minecraft/forge/.minecraft/libraries/net/minecraftforge/forge/1.19-41.1.0/unix_args.txt` and append this to `-DlegacyClassPath=`

----
:mods/kafka-clients-3.2.1.jar:mods/lz4-java-1.8.0.jar:mods/jackson-annotations-2.13.3.jar:mods/snappy-java-1.1.8.4.jar:mods/jackson-core-2.13.3.jar:mods/zstd-jni-1.5.2-1.jar:mods/jackson-databind-2.13.3.jar
----

Included in the project is my link:unix_args.txt[unix_args.txt] file.

NOTE: https://github.com/holly-cummins[Holly Cummins] do not have this issue in her project https://github.com/holly-cummins/quarkus-minecraft-observability-extension where she use undertow, servlet and jaxrs!
----
 implementation 'javax.ws.rs:javax.ws.rs-api:2.0.1'
 implementation 'org.jboss.resteasy:resteasy-jaxrs:4.0.0.Beta5'
 implementation 'org.jboss.resteasy:resteasy-undertow:4.0.0.Beta5'
 implementation 'javax.servlet:javax.servlet-api:3.0.1'
 implementation 'io.undertow:undertow-core:2.2.17.Final'
----

== Quarkus Kafka

The class `ItemStackProcessor` gets records from Kafka, extract the player and send it to `players`.

[source,java]
----
@Incoming("item-stack")
@Outgoing("players")
public Player process(String itemStack) throws InterruptedException {
    Player player = null;
    try {
        JsonNode itemStackObj = objectMapper.readTree(itemStack);
        JsonNode playerObj  = itemStackObj.get("player");
        player = new Player(playerObj);
    } catch (Exception e) {
        e.printStackTrace();
    }
    return player;
}
----

The class `PlayerResource` expose a `text/event-stream` endpoint for all updates to `players`.

Starting the app we are now able to use http://localhost:8081/players.html if in `dev` mode to see updates to players.

image::images/show_player_in_browser.png[]

== Kafka tasks

.Start Zookeeper

[source,bash]
----
cd /opt/apache/kafka/kafka_2.13-3.2.1
bin/zookeeper-server-start.sh config/zookeeper.propertie
----

.Start Kafka

[source,bash]
----
cd /opt/apache/kafka/kafka_2.13-3.2.1
bin/kafka-server-start.sh config/server.properties
----

.Consume the kafka-mod-chat topic

[source,bash]
----
cd /opt/apache/kafka/kafka_2.13-3.2.1
bin/kafka-console-consumer.sh \
    --topic kafka-mod-chat \
    --from-beginning \
    --bootstrap-server localhost:9092
----


.Consume the kafka-mod-chat topic

[source,bash]
----
cd /opt/apache/kafka/kafka_2.13-3.2.1
bin/kafka-console-consumer.sh \
    --topic kafka-mod-item-stack \
    --from-beginning \
    --bootstrap-server localhost:9092
----


